{
  "name": "Monday to Jira Sync",
  "meta": {
    "description": "Polls Monday for pending Jira requests in subitems, resolves reporter, creates tickets via MCP, writes links back."
  },
  "nodes": [
    {
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "notes": "Polls every 30 seconds.",
      "parameters": {
        "rule": {
          "interval": [{ "field": "seconds", "secondsInterval": 30 }]
        }
      }
    },
    {
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "notes": "Gets all parent item IDs from the Localization QA board.",
      "parameters": {
        "method": "POST",
        "url": "https://api.monday.com/v2",
        "body": "{\"query\": \"{ boards(ids: [18393273008]) { items_page(limit: 500) { items { id } } } }\"}"
      }
    },
    {
      "name": "Get subitem data",
      "type": "n8n-nodes-base.code",
      "notes": "Takes parent item IDs, builds a query to fetch subitems with column_values, filters for subitems with pending Jira requests (non-empty long_text_mm0cavf7). Outputs the parsed JSON ticket data.",
      "parameters": {
        "language": "javaScript",
        "jsCode": "// Step 1: Extract parent item IDs and build subitems query\nconst items = $input.first().json.data.boards[0].items_page.items;\nconst ids = items.map(i => i.id).join(',');\nconst query = `{ items(ids: [${ids}]) { id subitems { id name board { id } column_values(ids: [\"long_text_mm0cavf7\", \"link_mkz21j9b\"]) { id text value } } } }`;\n\n// Step 2: Fetch subitems via Monday API (uses same auth as HTTP Request node)\n// NOTE: This step is done via a second HTTP Request node in the actual workflow.\n// The code here filters the response for pending requests.\n\nconst response = $input.first().json;\nconst parentItems = response.data?.items || response.data?.boards?.[0]?.items_page?.items || [];\nconst results = [];\n\nfor (const item of parentItems) {\n  if (!item.subitems) continue;\n  for (const subitem of item.subitems) {\n    const requestCol = subitem.column_values.find(c => c.id === 'long_text_mm0cavf7');\n    let requestText = requestCol?.text || '';\n    if (!requestText && requestCol?.value) {\n      try { requestText = JSON.parse(requestCol.value).text || ''; } catch (e) {}\n    }\n    if (requestText.trim() !== '') {\n      try {\n        const requestData = JSON.parse(requestText);\n        results.push({ json: { ...requestData, subitemId: subitem.id, subitemName: subitem.name, boardId: subitem.board?.id || requestData.boardId } });\n      } catch (e) {}\n    }\n  }\n}\n\nreturn results;"
      }
    },
    {
      "name": "Get reporter email",
      "type": "n8n-nodes-base.mcpClientTool",
      "notes": "Uses jirabot__get_user to look up the Jira user by the reporterEmail from Monday's Person column.",
      "parameters": {
        "toolName": "jirabot__get_user",
        "inputMapping": "email: {{ $json.reporterEmail }}"
      }
    },
    {
      "name": "Merge reporter data",
      "type": "n8n-nodes-base.code",
      "notes": "Extracts accountId from get_user response and merges with original ticket data.",
      "parameters": {
        "language": "javaScript",
        "jsCode": "const userResponse = $input.first().json;\nconst accountId = userResponse.content?.[0]?.text?.[0]?.accountId || null;\nconst originalData = $('Get subitem data').first().json;\n\nreturn [{ json: { ...originalData, reporterAccountId: accountId } }];"
      }
    },
    {
      "name": "Create Jira",
      "type": "n8n-nodes-base.mcpClientTool",
      "notes": "Creates Jira ticket via MCP. Fields: projectKey, summary, description, issueTypeId (10024 = Bug). customFields includes labels and reporter accountId.",
      "parameters": {
        "toolName": "jirabot__create-issue",
        "fields": {
          "projectKey": "{{ $json.projectKey }}",
          "summary": "{{ $json.summary }}",
          "description": "{{ $json.description }}",
          "issueTypeId": "10024",
          "customFields": "{{ JSON.stringify(Object.assign({ \"labels\": $json.labels }, $json.reporterAccountId ? { \"reporter\": { \"accountId\": $json.reporterAccountId } } : {})) }}"
        }
      }
    },
    {
      "name": "Write Jira ticket",
      "type": "n8n-nodes-base.code",
      "notes": "Extracts Jira key from MCP response and prepares data for writing back to Monday.",
      "parameters": {
        "language": "javaScript",
        "jsCode": "const mcpResponse = $input.first().json;\nlet jiraKey = null;\nif (mcpResponse.content?.[0]?.text?.key) { jiraKey = mcpResponse.content[0].text.key; }\nelse if (mcpResponse.key) { jiraKey = mcpResponse.key; }\nif (!jiraKey) { throw new Error('Could not extract Jira key: ' + JSON.stringify(mcpResponse)); }\nconst prevData = $('Get subitem data').first().json;\nreturn [{ json: { jiraKey, jiraUrl: `https://wix.atlassian.net/browse/${jiraKey}`, boardId: prevData.boardId, subitemId: prevData.subitemId } }];"
      }
    },
    {
      "name": "Copy ticket URL to Monday",
      "type": "n8n-nodes-base.httpRequest",
      "notes": "Writes Jira link to subitem link column (link_mkz21j9b) and clears the request column (long_text_mm0cavf7).",
      "parameters": {
        "method": "POST",
        "url": "https://api.monday.com/v2",
        "body": "{{ JSON.stringify({ query: 'mutation { write_link: change_column_value(board_id: ' + $json.boardId + ', item_id: ' + $json.subitemId + ', column_id: \"link_mkz21j9b\", value: ' + JSON.stringify(JSON.stringify({ url: $json.jiraUrl, text: $json.jiraKey })) + ') { id } clear_request: change_column_value(board_id: ' + $json.boardId + ', item_id: ' + $json.subitemId + ', column_id: \"long_text_mm0cavf7\", value: ' + JSON.stringify(JSON.stringify({ text: '' })) + ') { id } }' }) }}"
      }
    }
  ],
  "connections": {
    "Schedule Trigger": { "main": [[{ "node": "HTTP Request" }]] },
    "HTTP Request": { "main": [[{ "node": "Get subitem data" }]] },
    "Get subitem data": { "main": [[{ "node": "Get reporter email" }]] },
    "Get reporter email": { "main": [[{ "node": "Merge reporter data" }]] },
    "Merge reporter data": { "main": [[{ "node": "Create Jira" }]] },
    "Create Jira": { "main": [[{ "node": "Write Jira ticket" }]] },
    "Write Jira ticket": { "main": [[{ "node": "Copy ticket URL to Monday" }]] }
  },
  "settings": { "executionOrder": "v1" }
}
